<!DOCTYPE html>
<html>
<head>
<title>Convert Fritzbox Phonebook Telefonbuch | webservice online</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name=”name” content=”title” lang="en" content="Convert Fritzbox Phonebook | webservice" />
<meta name=”name” content=”title” lang="de" content=">Umwandlung Fritzbox Telefonbuch | web-dienst" />
<meta name=”name” content=”description” lang="en" content="Online converter for phonebook files from router Fritzbox .xml : between .xml ↔ to / from .csv  ; or .xml ↔ to / from .vcf (vcard) and backwards" />
<meta name=”name” content=”description” lang="de" content="Online konvertierung umwandlung vom Telefonbuch der Fritzbox (.xml Datei) : zwischn.xml ↔ von / nach .csv  ; oder  .xml ↔ von / nach .vcf (vcard) und zurück." />
<meta property="og:title" lang="en" content="Convert Fritzbox Phonebook | webservice" />
<meta property="og:title" lang="de" content="Umwandlung Fritzbox Telefonbuch | web-dienst" />
<meta name=”name” content=”og:description” lang="en" content="Online converter for phonebook files from router Fritzbox .xml : between .xml ↔ to / from .csv  ; or .xml ↔ to / from .vcf (vcard) and backwards" />
<meta name=”name” content=”og:description” lang="de" content="Online konvertierung umwandlung vom Telefonbuch der Fritzbox (.xml Datei) : zwischn.xml ↔ von / nach .csv  ; oder  .xml ↔ von / nach .vcf (vcard) und zurück." />
<meta property="og:type" content="webapp" />
<link rel="icon" href="img/icon_convert_formats.png" sizes="141x96" />
<link rel="apple-touch-icon" href="img/icon_convert_formats.png" sizes="141x96" />
<meta property="og:url" lang="de" content="https://soerenj.codeberg.page/fritzbox_phonebook_convert_xml_csv_vcf/fritzbox_phonebook_convert.html#de" />
<meta property="og:url" lang="en" content="https://soerenj.codeberg.page/fritzbox_phonebook_convert_xml_csv_vcf/fritzbox_phonebook_convert.html#en" />
<link rel="canonical" href="https://soerenj.codeberg.page/fritzbox_phonebook_convert_xml_csv_vcf/fritzbox_phonebook_convert.html" />
<link rel="alternate" href="/fritzbox_phonebook_convert_xml_csv_vcf/fritzbox_phonebook_convert.html#en" lang="en" />
<link rel="alternate" href="/fritzbox_phonebook_convert_xml_csv_vcf/fritzbox_phonebook_convert.html#de" lang="de" />
<script type='application/ld+json'>
{
	"@context": "http://schema.org/",
	"@type": "WebApplication",
	"applicationCategory": "UtilitiesApplication",
	"applicationSubCategory": "convert",
	"image": "https://soerenj.github.io/fritzbox_phonebook_convert_xml_csv_vcf/img/icon_convert_formats.png",
	"isAccessibleForFree": "true",
	"license": "AGPL",
	"name": "convert phonebook Fritzbox",
	"description": "convert phonebook files from router Fritzbox .xml to .csv or to .vcf (vcard)",
	"mainEntityOfPage":"https://soerenj.github.io/fritzbox_phonebook_convert_xml_csv_vcf/",
	"url":"https://soerenj.github.io/fritzbox_phonebook_convert_xml_csv_vcf/",
	"SoftwareSourceCode": "https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv_vcf",
	"programmingLanguage": "javascript",
	"dateModified": "2025-05-23",
	"softwareVersion": "0.281",
	"inLanguage": ["en", "de"],
	"sameAs": "https://soerenj.codeberg.page/fritzbox_phonebook_convert_xml_csv_vcf/fritzbox_phonebook_convert.html"
}
</script>
<style>  input{ cursor: pointer } .advanced_view{ display:none; } textarea{ min-width:500pt;width:80%;height:100pt;} @media (min-height:800pt){ textarea{ height:200pt;} } details summary { color:LinkText;} details summary:hover, details summary :hover, a .en:hover, a .de :hover{ text-decoration:underline; cursor:pointer; color:#000; } details div { margin-left: 12pt; }
.drop-area_highlight, .drop-area_text_highlight  { border-color: purple; width: 90%; min-width:90%; height:90%; min-height:90%; background:rgba(64, 64, 64, 0.5); position:absolute;  top:0px; left:0px; border: 2px dashed #ccc; border-radius: 20pt; margin:5%; font-size: 3em; text-align: center;  padding-top: 25%;} .de{ display:none; } input#setting__xml2__phonenumber_edit_your_countrycode:invalid, input#setting__xml2__phonenumber_edit_your_areacode:invalid {border: medium solid red; } .onlytouchscreen{ display:none; } @media (pointer: coarse){.onlytouchscreen{ display:inline; } }</style>
</head>
<body>
<!--
 /*
 * version: 0.281
 * date: 2025-05-23
 *
 * Licence 
 *
 * Licence Exception: for function "CSVToArray()": "is provided as is and can be used at your own discretion" OR "MIT Licence" (c) 2025 Ben Nadel
 *
 * All other parts:
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 */
  -->
<header>
<img src="img/icon_convert_formats.png" style="float:left;padding:6pt;" />
<span style="float:right"><a href="#en" onClick="changeLanguage('en')" alt="en" hreflang="en" title="change language to english">&#127468&#127463</a> <a href="#de" onClick="changeLanguage('de')" hreflang="de" alt="de" title="wechsel die Sprache zu deutsch / german">&#127465&#127466</a></span>
<h1 lang="en" class="en">Phonebook Contact convert for Fritzbox</h1>
<h1 lang="de" class="de">Telefonbuch Kontakte konvertieren für Fritzbox</h1>
<p lang="en" class="en">Converts Fritzbox-XML-Files to/from .CSV or .VCF(vcard)-File with Phone Numbers.</p>
<p lang="de" class="de">Konvertiert Fritzbox-XML-Dateien zu/von .CSV oder .VCF(vcard)-Dateien mit Telefonnummer</p>
<span style="clear:both"></span><br>
</header>
<noscript style="color:red">You need JavaScript, to use this service.</noscript>
<hr>
<div id="select_file_auto-detect_div">
<span lang="en" class="en">Select &nbsp;- or -&nbsp; drag & drop file(s): </span>
<span lang="de" class="de">Auswählen &nbsp;- oder -&nbsp; hier reinziehen von Datei(en) <span style="color:#999;">("drag & drop")</span>:</span>
<br />
<span style="color:#999999"><i><span lang="en" class="en">Allowed</span><span lang="de" class="de">Erlaubt</span>: Fritzbox .xml , .csv , .vc , .vcard</i></span><br>
<span id="file-input_auto-detect_text_drophere" style="display:none">Drop your file here</span>
<input type="file" multiple id="file-input_auto-detect" autocomplete="off" /><a href="#" id="file-input_auto-detect_close_button" style="display:none;background: white;  font-size: 2em;  text-align: right;  top: 10%;  position: absolute;  padding: 0.5em;  right: 10%; border-radius:20pt;" onClick="unhighlight();return false;">Close X</a><br>
</div><br>
<div id="select_file_xml_div" class="advanced_view">
<label for="phonebook_xml">From Fritzbox .XML File:</label><br>
<textarea id="phonebook_xml" autocomplete="off">
<?xml version="1.0" encoding="utf-8"?>
<phonebooks>
<phonebook owner="" name="phonebook1">
<contact>
<category>0</category>
<person><realName>Person A</realName></person>
<telephony nid="1"><number type="mobile" prio="1" id="0" quickdial="1" vanity="01">0176123456789</number></telephony>
<services /><setup />
<features doorphone="0" /><mod_time>1535972380</mod_time><uniqueid>227</uniqueid>
</contact>
<contact>
<category>0</category>
<person><realName>Person B</realName></person>
<telephony nid="1"><number type="mobile" prio="1" id="0">+49176987654321</number></telephony>
<services nid="1"><email classifier="private" id="0">test@example.com</email></services><setup />
<features doorphone="0" /><mod_time>1535972450</mod_time><uniqueid>229</uniqueid>
</contact>
</phonebook>
</phonebooks>
</textarea>
</div>

<div id="ready" style="display:none;margin-top:5pt;margin-left: 50pt;background: #ddd;padding: 10pt;border-radius: 5pt;">
 <span lang="en" class="en">Ready. Check now your download folder</span>
 <span lang="de" class="de">Fertig. Überprüfen Sie Ihren Download-Ordner</span>
</div>
<div id="ready_note_export_to_vcf_multivcard" style="margin-top:5pt;display:none;margin-left: 50pt;background: #ddd;padding: 10pt;border-radius: 5pt;">
 <span lang="en" class="en">Please Note: This is a Multi-Vcard file. It have all Contacts in one File. Some Programs does not support this. <br>Split: If you need a vcard-file per each Person: <a href="#" onclick="convert_to_vcf(true);return false;">Split in <span id="ready_note_export_to_vcf_multivcard__counter_splited1">X</span> seperated files<a/>.<br> Alternativ: please try this other tool: <a href="https://blog.rillke.com/fritzXML2vcard/">https://blog.rillke.com/fritzXML2vcard/</a></span>
 <span lang="de" class="de">Bitte beachten Sie: Die ist eine Multi-Vcard Datei. Sie enthält alle Kontakte in einer Datei. Manche Programme unterstützen dies nicht. <br>Aufteilen: Wenn sie jedoch je Person eine einzelne Vcard-Datei benötigen: <a href="#" onclick="convert_to_vcf(true);return false;">Aufteilen in <span id="ready_note_export_to_vcf_multivcard__counter_splited2">X</span> verschiedene Dateien<a/>.<br> Alternativ: Bitte eine anderes Tool verwenden: z.B.: <a href="https://blog.rillke.com/fritzXML2vcard/">https://blog.rillke.com/fritzXML2vcard/</a></span>
</div>
<div id="ready_note_export_to_vcf_allversions" style="margin-top:5pt;display:none;margin-left: 50pt;background: #ddd;padding: 10pt;border-radius: 5pt;">
 <span lang="en" class="en">Please Note: There was three files created. There have different vcard Version (v2.1 , v3.0 , v4.0). Which file you need may depends on your target.</span>
 <span lang="de" class="de">Bitte beachten Sie: Es wurden drei Dateien erstellt. Es sind verschiedene vcard Versionen (v2.1 , v3.0 , v4.0). Welche Datei Sie benötigen, kommt auf ihr Ziel-Programm an.</span>
</div>

<!-- ↓↑ ⇓⇑ ⇩⇧ ⟱ ⟰ ⬆⬇ -->
<br>
<div class="advanced_view">
 <input type="button" value="convert: ⬇ xml to csv" onclick="convert_to_csv()" />  &nbsp;
 <input type="button" value="convert: ⬇ xml to vcf (vcard)" onclick="convert_to_vcf()" />  &nbsp;
 <input type="button" value="Download" title="Download one file" onclick="download_one_file_ask()" />   &nbsp; 
 <input type="button" value="✖ Reset to Test-Values" title="reset to default" onclick="reset_to_default()" />   &nbsp;  
</div>
<br/>
<div id="select_file_xml_csv" class="advanced_view">
<br><br>
<label for="phonebook_csv">From .CSV File:</label> <input type="button" value="convert: ⇧ csv to xml" onclick="convert_csv_to_xml()" />   &nbsp;  <br>
<textarea id="phonebook_csv" autocomplete="off">name, phone, type, importantPerson, email, quickdial, vanity
"Person C", "080123456789"
"Person C", "0801234567890978768"
"Person C", "01769999999"
"Person D", "+49176987654321", "+498091239856789"
"Person E", "004949176222222", "mobile", "", "test@example.com"
"Person E", "+4911111", "work", "1", "test@example.com", 8, 1
"Person E", "00494933333", "home", "", "test@example.com"
</textarea>
<br>
</div>

<div id="select_file_vcf_div" class="advanced_view">
<label for="phonebook_vcf">From .VCF File:</label> <input type="button" value="convert: ⇧ vcf to xml" onclick="convert_vcf_to_xml()" />   &nbsp;  <br>
<textarea id="phonebook_vcf" autocomplete="off">BEGIN:VCARD
VERSION:4.0
N:Person E
FN:Person E
TEL;TYPE=WORK;VOICE:090123456789
END:VCARD
BEGIN:VCARD
VERSION:2.1
N:Person=20F
FN:Person=20F
TEL;VOICE:+4990987654321
NOTE:importantContact(fritzbox)
END:VCARD

</textarea>
</div>

<p id="show_advanced_view_link_link_close" style="display:none">
<a href="#" onclick="show_advanced_view('hide');return false">
    <span lang="en" class="en">close text source window</span>
    <span lang="de" class="de">schließe Text-Fenster</span>
</a>
</p>
<p id="show_advanced_view_link_wrapper">
  <a href="#" onclick="show_advanced_view('show');return false">
    <span lang="en" class="en">show text source window</span>
    <span lang="de" class="de">Text-Fenster anzeigen </span>
  </a>
</p>

<textarea id="error_logs" style="display:none" class=""></textarea>

<div>
 <details>
  <summary>
   <span lang="en" class="en" >⚙ Settings</span>
   <span lang="de" class="de">⚙ Einstellungen</span>
  </summary>
  <fieldset><legend>Settings</legend>
  <div>
  <fieldset >
    <legend>
      <span lang="en" class="en">Uploaded file</span>
      <span lang="de" class="de">Hochgeladene Datei</span>
    </legend>
    <input type="checkbox" onChange="var e=document.getElementById('file-input_auto-detect');if(!this.checked) e.accept=''; else e.accept=file_upload__accepted_filetype;" id="setting__upload__filetype_only_accepted" checked autocomplete="off">
    <label for="setting__upload__filetype_only_accepted">
      <span lang="en" class="en">Show only supported files (.xml / .csv / .vcf / ~) <span style="color:#999">( only these are selectable in file upload window/dialog in browser )</span></span>
      <span lang="de" class="de">Zeige nur unterstützte Dateien (.xml / .csv / .vcf / ~) an <span style="color:#999">( nur diese sind auswählbar im Datei-auswählen Fenster im Browser )</span></span>
    </label> <br />
    <input type="checkbox" id="setting__upload__filetype_auto_detect" checked autocomplete="off">
    <label for="setting__upload__filetype_auto_detect">
      <span lang="en" class="en">Automatic detection of file-type</span>
      <span lang="de" class="de">Automatisch Datei-Type feststellen</span>
    </label> <span style="color:#999">(detected by file-extension .xml / .csv / .vcf /.vcard /or MIME-Type ; Otherwise you will be ask)</span>
  </fieldset>
  <fieldset ><legend>* to xml (=import to fritzbox)</legend>
    <!--<span lang="en" class="en">Phone-Number edits:</span>
    <span lang="de" class="de">Telefon-Nummer bearbeiten:</span>-->
    <p style="margin: 0pt;">

    <input type="checkbox" id="setting__2xml__phonenumber_edit_detect_mobile__active" autocomplete="off" checked/>
    <label for="setting__2xml__phonenumber_edit_detect_mobile__active">
     <span lang="en" class="en">Detect mobile phone-number (if already not set). <span style="color:#999">(to fit in the number categorie)</span></span>
     <span lang="de" class="de">Mobilfunk-Nummer automatisch erkennen (wenn noch nicht festgelegt). <span style="color:#999">(damit die Nummern Kategorie passt)</span></span>
    </label>
    <label for="setting__2xml__phonenumber_edit_detect_mobile__your_countrycode">
     <span lang="en" class="en">Therefore, set your own country:</span>
     <span lang="de" class="de">Dafür ihr Land festlegen:</span>
    </label>
    <select name="setting__2xml__phonenumber_edit_detect_mobile__your_countrycode" id="setting__2xml__phonenumber_edit_detect_mobile__your_countrycode" autocomplete="off">
      <option value="">-</value>
    </select>
    </p>
  </fieldset>
  <fieldset ><legend>xml to * (=export from fritzbox)</legend>
    <!--<span lang="en" class="en">Phone-Number edits:</span>
    <span lang="de" class="de">Telefon-Nummer bearbeiten:</span>-->
    <p style="margin: 0pt;">
    <input type="checkbox" id="setting__xml2__phonenumber_edit_your_countrycode__active" autocomplete="off" />
    <label for="setting__xml2__phonenumber_edit_your_countrycode__active">
     <span lang="en" class="en">Add your Telephone country codes:</span>
     <span lang="de" class="de">Ihre Land-Vorwahl hinzufügen:</span>
    </label><!-- v(([0-9][0-9])|(\+)) -->
    <input type="text" size="8" pattern="((00)|\+)[0-9][0-9]*?" name="setting__xml2__phonenumber_edit_your_countrycode" id="setting__xml2__phonenumber_edit_your_countrycode" autocomplete="off" />
    <span lang="en" class="en" style="color:#999">(if missing) Example: +49 or 0049 for germany.</span>
    <span lang="de" class="de" style="color:#999">(wenn sie fehlt) Beispiel: +49 oder 0049 für Deuschland.</span>
    </p>
    <p style="margin: 0pt;">
    <input type="checkbox" id="setting__xml2__phonenumber_edit_your_areacode__active" autocomplete="off" />
    <label for="setting__xml2__phonenumber_edit_your_areacode__active">
     <span lang="en" class="en">Add your local Area (City/Town) code:</span>
     <span lang="de" class="de">Ihre lokale Stadt/Orts-Vorwahl hinzufügen:</span>
    </label><!-- v(([0-9][0-9])|(\+)) -->
    <input type="text" size="8" pattern="0[1-9][0-9].*?" name="setting__xml2__phonenumber_edit_your_areacode" id="setting__xml2__phonenumber_edit_your_areacode" autocomplete="off" />
    <span lang="en" class="en" style="color:#999">(if missing) Example: 030 for City Berlin in Germany.</span>
    <span lang="de" class="de" style="color:#999">(wenn sie fehlt) Beispiel: 030 für die Stadt Berlin.</span>
    </p>
  </fieldset>
  <fieldset ><legend>xml to csv (=export from fritzbox)</legend>
    <span lang="en" class="en">How to handle multiple phone numbers per each Person entry:</span>
    <span lang="de" class="de">Wie mit mehreren Telefon-Nummern je Personen-Eintrag umgegangen werden soll:</span>
    <p style="margin: 0pt;"><input type="radio" autocomplete="off" id="setting__xml2csv__just_one_phonenumer_each_text__single_row" name="setting__xml2csv__just_one_phonenumer_each_text" value="1" autocomplete="off" onChange="setting__xml2csv__just_one_phonenumer_each=this.value" /> <label for="setting__xml2csv__just_one_phonenumer_each_text__single_row">
    <span lang="en" class="en">Each table-row can have multiple phone-numbers (= multiple columns)</span>
    <span lang="de" class="de">Jede Tabellen-Zeile kann mehrere Telefon-Nummern enthalten (=mehrere Spalten)</span>
    <br /><div style="margin-left:30pt;color:#999">Example output:<br/>Person A, +4940-1234, +4940-567</div></label></p>
    <p style="margin: 0pt;"><input type="radio" autocomplete="off" id="setting__xml2csv__just_one_phonenumer_each_text__multiple_rows" name="setting__xml2csv__just_one_phonenumer_each_text" value="2" autocomplete="off" onChange="setting__xml2csv__just_one_phonenumer_each=this.value" /> <label for="setting__xml2csv__just_one_phonenumer_each_text__multiple_rows">
    <span lang="en" class="en">Each table-row has only a single phone-number (per row )</span>
    <span lang="de" class="de">Jede Tabellen-Zeile darf nur eine einzelene Telefon-Nummer enthalten (je Zeile)</span>
    <br /><div style="margin-left:30pt;color:#999">Example output:<br/>Person A, +4940-1234 <br/ >Person A, +4940-567</div><!--<s><span style="color:#999">Going back with this Result data (= from xml to csv): Converting backward currently can't merge the contacts to a single entry ( <i>=you will have too much entry in your phonebook</i>).</span></s>--></label></p>
    <p style="margin: 0pt;"><input type="radio" autocomplete="off" id="setting__xml2csv__just_one_phonenumer_each_text__multiple_rows__with_type" name="setting__xml2csv__just_one_phonenumer_each_text" value="3" autocomplete="off" onChange="setting__xml2csv__just_one_phonenumer_each=this.value" /> <label for="setting__xml2csv__just_one_phonenumer_each_text__multiple_rows__with_type">
    <span lang="en" class="en">Each table-row has only a single phone-number (per row ) and has addational data: phone type-categorie (=mobile,privat,work,work_fax), priority (=imported person), email-adress, addational quick-dial and telephone book search-Number("Vanity")</span>
    <span lang="de" class="de">Jede Tabellen-Zeile darf nur eine einzelne Telefon-Nummer enthalten (je Zeile) und hat zusätzlich: Telefon Type-Kategorie (=mobile,privat,work,work_fax), Priorität (=wichtige Person), Email-adresse, sowie Kurzwahltaste und Telefonbuchsuche-Zahl("Vanity")</span>
    <br /><div style="margin-left:30pt;color:#999">Example output:<br/>Person A, +4940-1234, mobile, 1, mail@example.com <br/ >Person A, +4940-567, home</div>
    <!--<s><span style="color:#999">Going back with this Result data (= from xml to csv): Converting backward currently can't restore the addational information ( <i>type (mobile/home) and Priority(=important Person)</i>).</span></s>--></label></p>
  </fieldset>
  <fieldset ><legend>csv to xml (=import to fritzbox)</legend>
    <span lang="en" class="en">How to handle multiple phone numbers per each Person entry:</span>
    <span lang="de" class="de">Wie mit mehreren Telefon-Nummern je Personen-Eintrag umgegangen werden soll:</span>
    <p style="margin: 0pt;"><input type="checkbox" autocomplete="off" id="setting__csv2xml__merge_samename_checkbox" name="setting__csv2xml__merge_samename" value="1" autocomplete="off" checked onChange="if(this.checked==true)setting__csv2xml__merge_samename=1;else setting__csv2xml__merge_samename=0;" />
    <label for="setting__csv2xml__merge_samename_checkbox">
      <span lang="en" class="en">Merge to a single entry</span>
      <span lang="de" class="de">Einträge zusammenfassen</span>
    </label>
    <div style="margin-left:30pt;">
     <span lang="en" class="en">Phone-numbers with the same name will be merged to a single Entry.</span>
     <span lang="de" class="de">Telefon-Nummern mit den selben Namen werden zusammengefasst als ein Eintrag.</span>
     <br>
     <span style="color:#999">Example csv input:<br/>
      <ul style="margin-top:0;margin-bottom:0;"><li>Person A, +4940-1234, +4940-567</li><li>Person A, +4940-1234 <br/ >Person A, +4940-567</li><li><span style="color:#999"><i> (Headline: name ; phone ; mobile/home/work/fax_work ; 1 (=for important contact) ; e-mail-adress ; quickdial ; vanity )</i><br></span>Person A, +4940-1234, mobile, 1 , mail@example.com <br/ >Person A, +4940-567, home<br/></li></ul>
      <span lang="en" class="en">Note about <em>important person</em> ("<em>prio</em>"): If a single number is <em>prio</em>, all entrys of this person name will be <em>prio</em>.</span>
      <span lang="de" class="de">Anmerkung zu <em>wichtige Personen</em> ("Prio"): Wenn irgendeiner der Einträge einer Person als <em>wichtige Person</em> markiert ist, wird das auch für alle anderen Einträge diese Person übertragen.</span>
     </span> </div></p>
    <p style="margin: 0pt;"> <input type="checkbox" autocomplete="off" id="setting__csv2xml__max_per_entry_checkbox" name="setting__csv2xml__max_per_entry" value="" autocomplete="off" checked onChange="if(this.checked==true)document.getElementById('setting__csv2xml__max_per_entry_input').disabled=false;else document.getElementById('setting__csv2xml__max_per_entry_input').disabled=true;" /><label for="setting__csv2xml__max_per_entry_input">
    <label for="setting__csv2xml__max_per_entry_checkbox">
     <span lang="en" class="en">Split entrys:</span>
     <span lang="de" class="de">Teile Einträge auf:</span>
    </label> <div style="margin-left:30pt;">Maximal <input size="2" type="number" autocomplete="off" id="setting__csv2xml__max_per_entry_input" name="setting__csv2xml__max_per_entry" value="9" autocomplete="off" checked onChange="setting__csv2xml__max_per_entry=this.value" />
    <label for="setting__csv2xml__max_per_entry_input">
     <span lang="en" class="en"> phone numbers are allowed per each entry. Then create a 2nd,3th,... entry (with the same name).</span>
     <span lang="de" class="de">Telefon-Nummern sind erlaubt für jeden Eintrag. Dannach wird eine zweiten,dritter,... Eintrag (mit den selben Namen) erstellt.</span>
    </label><br/>
    <span style="color:#999">
     <span lang="en" class="en">Example: on device <em>Fritzbox 7390</em>: That device allow normally maximal 9 numbers per each entry. But it looks like, you can also import entry with more numbers. But, then you will get some problem or error: you can't delete the last phone numbers (>9), but they are still editable. ( Maybe other problems possible.) My advise: Bedder set split to 9 - or -  test yourself how many phone numbers you can add (in Web Interface in Browser fritz.box).</span>
    <span lang="de" class="de">Beispiel: beim Gerät <em>Fritzbox 7390</em>: Bei diesen Gerät sind normalerweise maximal 9 Telefon-Nummer in jeden Eintrag möglich. Es ist scheinbar trotzdem möglich Telefonbücher mit mehr Telefon-Nummern je Eintrag, zu importieren. Es kommt dann aber zu Problemen oder Fehlern: Die letzten Telefon-Nummern (>9) sind dann nicht mehr löschbar, aber noch bearbeitet-bar. (Möglicherweise andere Probleme möglich.) Meine Empfehlung: Besser bei 9 Telefon-Nummern aufteilen - oder - selber testen wie viele Telefon-Nummern je Eintrag ihre Gerät erlaubt (im der Benutzeroberfläche ( Web-Interface auf fritz.box ) )</span>
    </span></div></p>
  </fieldset>
  <fieldset ><legend>xml to .vcf (=export from fritzbox)</legend>
    <p style="margin: 0pt;">
    <script language="javascript">
    function settings_ui_toggleVcfAllV(show){
      document.getElementById('set_vcf_only_for2.1').style.display='block';
      if(show){
        document.getElementById('setting__xml2vcf__version__container').style.display='none';
        if(show_advanced_view__state) var e=document.getElementsByClassName('no_for_textfields');
      }else{
        document.getElementById('setting__xml2vcf__version__container').style.display='block'; if(document.getElementById('setting__xml2vcf__version').value!='2.1') document.getElementById('set_vcf_only_for2.1').style.display='none';
      }
    }
    </script>
    <input type="checkbox" id="setting__xml2vcf__allversions" autocomplete="off" checked onChange="settings_ui_toggleVcfAllV(this.checked)"/>
    <label for="setting__xml2vcf__allversions">
      <span lang="en" class="en">Convert to all VCard-Versions at the same time (=you get three files)<!-- <span style="color:#999">(only for uploaded files. That means: not for the Textarea / <em>text source window<em> view)</span>--></span>
      <span lang="de" class="de">Konvertiere in alle VCard-Versionen gleichzeitig (=Sie erhalten drei verschiedene Dateien)<!--<span style="color:#999">(nur für hochgeladene Dateien. Also nicht für die Textarea / <em>Text-Fenster</em> Ansicht)</span>--></span>
    </label><br/>
    <span id="setting__xml2vcf__version__container" style="display:none;">
    <label for="setting__xml2vcf__version">VCard Version:</label>
    <select name="setting__xml2vcf__version" id="setting__xml2vcf__version" autocomplete="off" onChange="if(this.value=='2.1')document.getElementById('set_vcf_only_for2.1').style.display='block';else document.getElementById('set_vcf_only_for2.1').style.display='none';">
      <option value="2.1" selected>v2.1</option>
      <option value="3.0">v3.0</option>
      <option value="4.0">v4.0</option>
    </select>
    </span>
    <fieldset id="set_vcf_only_for2.1" style="display:block">
    <legend>
      <span lang="en" class="en">Improve data of file-version v2.1: (no changes needed here)</span>
      <span lang="de" class="de">Verbessere die Daten von Datei-Version v2.1: (keine Änderungen nötig)</span>
    </legend>
    <input type="checkbox" id="setting__xml2vcf__uri_encode" autocomplete="off" checked />
    <label for="setting__xml2vcf__uri_encode">
      <span lang="en" class="en">URI-Encoding for name, email. (maybe helpfull for Special Characters, <em>German: Umlauten</em>, empty spaces)</span>
      <span lang="de" class="de">URI-Encoding für Name, Email. (hilf evtl. bei Sonderzeichen, Umlauten, Leerzeichen)</span>
    </label><br/>
    <input type="checkbox" id="setting__xml2vcf__add_charset" autocomplete="off" checked />
    <label for="setting__xml2vcf__add_charset">
      <span lang="en" class="en">Add to String charset:UTF-8</span>
      <span lang="de" class="de">Füge den Zeichensatz (EN:"Charset") zum Text hinzu</span>
    </label>
    </fieldset>
    <span lang="en" class="en">Export addational data: </span>
    <span lang="de" class="de">Exportiere diese weiteren Felder: </span>
    <input type="checkbox" id="setting__xml2vcf__also_phonetype" checked autocomplete="off" />
    <label for="setting__xml2vcf__also_phonetype">
      <span lang="en" class="en">phone-type (mobile,work,...)</span>
      <span lang="de" class="de">Telefon-Type (mobile,work,...)</span>
    </label> &nbsp;
    <input type="checkbox" id="setting__xml2vcf__also_prio" checked autocomplete="off" />
    <label for="setting__xml2vcf__also_prio">
      <span lang="en" class="en">marked Note for important Person (=just a note)</span>
      <span lang="de" class="de">markierung als wichtige Person(nur eine notiz)</span>
    </label> &nbsp;
    <input type="checkbox" id="setting__xml2vcf__also_email" checked autocomplete="off" />
    <label for="setting__xml2vcf__also_prio">
      <span lang="en" class="en">Email</span>
      <span lang="de" class="de">Email</span>
    </label>
    </p>
    <span lang="en" class="en">At splited (=seperated) files Export: </span>
    <span lang="de" class="de">Bei geteilte dateien export: </span>
    <input type="checkbox" id="setting__xml2vcf__splited__filename_fullname" autocomplete="off" />
    <label for="setting__xml2vcf__splited__filename_fullname">
      <span lang="en" class="en">Filename: Full Name</span>
      <span lang="de" class="de">Dateiname: Ganze Name</span>
    </label>
    </p>
  </fieldset>
  <br />
  <label for="new_phonebook_name">
    <span lang="en" class="en">Name of new Phonebook-Name: </span>
    <span lang="de" class="de">Name des Telefonbuches:</span>
  </label>
  <input type="text" value="phonebook_name" title="" id="new_phonebook_name" onchange="new_phonebook_name=this.value" autocomplete="off" /> 
  <span style="color:#999;">
    <span lang="en" class="en">That is the shown new Phonebook-Name in the Fritzbox. This is not the filename.</span>
    <span lang="de" class="de">Das ist der neue Telefonbuch-Namen in der Fritzbox selbst. Es ist nicht der Datei-Name.</span>
  </span>
  <button type="button" onClick="document.getElementById('file-input_auto-detect').dispatchEvent(new Event('change'));" id="convert_again_file" style="display:none;margin-top:10pt;margin-bottom:10pt;" value="Convert the same file again" ><span lang="en" class="en">Convert the same file again</span><span lang="de" class="de">Konvertiere die gleiche Datei nochmal</span></button>
  </div>
  </fieldset>
 </details>
 
</div>

<input type="button" id="file-input_reset" style="display:none;margin-top:22pt" value="reset" onclick="reset_to_default()" />

<script language="JavaScript">
<!--
var uploaded_file_convert_from = '';
var uploaded_file_convert_to = '';
var counter_convert = 0;
var show_advanced_view__state = false;
var new_phonebook_name = 'convertedPhonebook';
var setting__xml2csv__just_one_phonenumer_each = 3;
var setting__csv2xml__merge_samename = 1;
var maxPhoneNumbersPerEntry = 9; //maximal Numbers on Fritzbox 7390 per each contact
var phonetypes = ["mobile","home","work","fax_work"];//on fritzbox 7390

var pre_numbers__with_country_codes__and_mobile = [
 ["de","de","+49","1[567]"],
 ["fr","fr","+33","[67]"],
 ["nl","nl","+31","6"],
 ["gb","en-gb","+44","(7[12345])|(7624)|(7[789])"],
 ["at","de-at","+43","(65[0123579])|(66[013456789])"],
 ["ch","(de-ch)|(fr-ch)|(it-ch)","+41","7[456789]"],
 ["be","(nl-be)|(fr-be)","+32","4[06789]"],
 ["lu","(de-lu)|(fr-lu)","+352","(621)|(661)|(691)"]
]; //for country language codes the order could be important (later on put the longer string)
 // escape: \ must be escaped with \ before => \\

var detected_default_langcode='';
var detected_default_langcountrycode='';
var e = document.getElementById("setting__2xml__phonenumber_edit_detect_mobile__your_countrycode");
for(i=0;i<pre_numbers__with_country_codes__and_mobile.length;i++){
 var a=pre_numbers__with_country_codes__and_mobile[i];
 var pattern = "^"+a[1];
 var option = document.createElement("option");
 var language = window.navigator.userLanguage || window.navigator.language;
 if(language.search(RegExp(pattern))>=0){
  if(detected_default_langcode.length<a[0].length){ 
    detected_default_langcode=a[0];
    detected_default_langcountrycode=a[2];
    }
 }
 option.text = a[0]+" "+a[1]+" "+a[2];
 option.value = a[2];
 e.add(option);
 if(detected_default_langcountrycode!='') document.getElementById('setting__xml2__phonenumber_edit_your_countrycode').value=detected_default_langcountrycode;
}
if(detected_default_langcountrycode!='')e.value=detected_default_langcountrycode;

if(document.getElementById('file-input_auto-detect').value!='')document.getElementById('file-input_reset').style.display='block';
document.getElementById('new_phonebook_name').value=new_phonebook_name;
var file_upload__accepted_filetype = ".vcf,.xml,.vcard,.csv,text/csv,text/vcard,text/x-vcard,text/directory;profile=vCard,text/directory,application/xml,text/xml";
var e =document.getElementById('file-input_auto-detect'); if(e.accept!=undefined)e.accept=file_upload__accepted_filetype
if(setting__xml2csv__just_one_phonenumer_each==1) document.getElementById('setting__xml2csv__just_one_phonenumer_each_text__single_row').checked=true;
if(setting__xml2csv__just_one_phonenumer_each==2) document.getElementById('setting__xml2csv__just_one_phonenumer_each_text__multiple_rows').checked=true;
if(setting__xml2csv__just_one_phonenumer_each==3) document.getElementById('setting__xml2csv__just_one_phonenumer_each_text__multiple_rows__with_type').checked=true;
if(setting__csv2xml__merge_samename==0) document.getElementById('setting__csv2xml__merge_samename_checkbox').checked=false;
if(setting__csv2xml__merge_samename==1) document.getElementById('setting__csv2xml__merge_samename_checkbox').checked=true;


function reset_to_default(){
 document.getElementById('phonebook_xml').value = document.getElementById('phonebook_xml').defaultValue;
 document.getElementById('phonebook_csv').value = document.getElementById('phonebook_csv').defaultValue;
 document.getElementById('phonebook_vcf').value = document.getElementById('phonebook_vcf').defaultValue;
 document.getElementById('file-input_auto-detect').value='';
 document.getElementById('ready').style.display="none";
}


function convert_to_csv(){
 var text = document.getElementById('phonebook_xml').value;
 parser = new DOMParser();
 xmlDoc = parser.parseFromString(text, "text/xml");

 var out, contacts, contact, person, telephony, telefone_numbers, telefone_numbers_type, telefone_numbers_prio, phone, email;
 if(setting__xml2csv__just_one_phonenumer_each==1) out = 'name, phone, (maybe more phones following...)\n';
 if(setting__xml2csv__just_one_phonenumer_each==2) out = 'name, phone\n';
 if(setting__xml2csv__just_one_phonenumer_each==3) out = 'name, phone, type, importantPerson, email, quickdial, vanity\n';
 logError=[];
 var contacts = xmlDoc.getElementsByTagName("contact");
 for(i=0;i<contacts.length;i++)
 {
  //check values
  if(
    (undefined==contacts[i].getElementsByTagName("person")[0]) ||
    (undefined==contacts[i].getElementsByTagName("person")[0].getElementsByTagName("realName")[0]) ||
    (undefined==contacts[i].getElementsByTagName("person")[0].getElementsByTagName("realName")[0].firstChild) ||
    (undefined==contacts[i].getElementsByTagName("telephony")[0]) ||
    (undefined==contacts[i].getElementsByTagName("telephony")[0].getElementsByTagName("number")[0]) ||
    (undefined==contacts[i].getElementsByTagName("telephony")[0].getElementsByTagName("number")[0].firstChild)
  ){ logError.push(contacts[i].innerHTML); continue; }
  
  person    = contacts[i].getElementsByTagName("person")[0].getElementsByTagName("realName")[0].firstChild.nodeValue;
  telephony = contacts[i].getElementsByTagName("telephony")[0].getElementsByTagName("number");
  if( contacts[i].getElementsByTagName("services").length>0 &&
      contacts[i].getElementsByTagName("services")[0].getElementsByTagName("email").length>0)
      email = contacts[i].getElementsByTagName("services")[0].getElementsByTagName("email")[0].firstChild.nodeValue; else email = '';
  //telefone_numbers = Array(); telefone_numbers_type = Array(); telefone_numbers_prio = Array();
  //out += '"'+person.replace('"','\\"')+'"';
  var counter_num=0;
  var type = '';
  var prio = null;
  var hasQuickDial=false;
  var hasVanity   =false;
  for(j=0;j<telephony.length;j++){
   //telefone_numbers.push (  telephony[i].firstChild.nodeValue );
   //telefone_numbers_type.push (  telephony[i].getAttribute('type') );
   //telefone_numbers_prio.push (  telephony[i].getAttribute('prio') );
   //if(telephony[j].length==undefined) continue; 
   if(null==telephony[j].firstChild || undefined==telephony[j].firstChild.nodeValue || null==telephony[j].firstChild.nodeValue) { logError.push(person); if(telephony[j].firstChild==null)logError.push('empty number:'); logError.push(telephony[j]);  continue; }
   phone = telephony[j].firstChild.nodeValue;
   phone = myTrimQuotes(phone);
   if(document.getElementById('setting__xml2__phonenumber_edit_your_areacode__active').checked &&
     !document.getElementById('setting__xml2__phonenumber_edit_your_areacode').validity.patternMismatch ){
     var areacode__pre_phone='';
     areacode__pre_phone=document.getElementById('setting__xml2__phonenumber_edit_your_areacode').value;
     if(areacode__pre_phone.substring(0,1)=="0")areacode__pre_phone=areacode__pre_phone.substring(1);
     if(phone.substring(0,1)!="0" && areacode__pre_phone!='' && phone.match(/[2-9][0-9][0-9].*?/).length>0)phone="0"+areacode__pre_phone+phone;
   }
   if(document.getElementById('setting__xml2__phonenumber_edit_your_countrycode__active').checked &&
     !document.getElementById('setting__xml2__phonenumber_edit_your_countrycode').validity.patternMismatch ){
     var countrycode__pre_phone='';
     countrycode__pre_phone=document.getElementById('setting__xml2__phonenumber_edit_your_countrycode').value;
     if(phone.length>2 && phone.substring(0,1)!="+" && phone.substring(0,1)=="0" && phone.substring(0,2)!="00" && countrycode__pre_phone!='') phone=""+countrycode__pre_phone+""+phone.substring(1);
   }
   if(counter_num>0  && setting__xml2csv__just_one_phonenumer_each>1) out += "\n";
   if(counter_num==0 || setting__xml2csv__just_one_phonenumer_each>1) out += '"'+myTrimQuotes(person).replace('"','\\"')+'"';
   out += ", "+ '"'+phone.replace('"','\\"')+'"';
   if(setting__xml2csv__just_one_phonenumer_each==3){
       if(telephony[j].getAttribute('type')!=undefined && telephony[j].getAttribute('type')!=null)
         out += ', "'+telephony[j].getAttribute('type')+'"'; else out += ', ';
       if(telephony[0].getAttribute('prio')!=undefined && telephony[0].getAttribute('prio')!=null)
         out += ', "'+telephony[0].getAttribute('prio')+'"'; else out += ', ';
       if(email!='')
         out += ', "'+email+'"';else out += ', ';
       if(telephony[j].getAttribute('quickdial')!=undefined && telephony[j].getAttribute('quickdial')!=null) {
         out += ', "'+telephony[j].getAttribute('quickdial')+'"';
         if(hasQuickDial)logError.push("Warning:more than one QuickDial per contact not allowed (at least at fritzbox 7390): "+telephony[j]); hasQuickDial=true; } else out += ', ';
       if(telephony[j].getAttribute('vanity')!=undefined && telephony[j].getAttribute('vanity')!=null) {
         out += ', "'+telephony[j].getAttribute('vanity')+'"';
         if(hasVanity)   logError.push("Warning:more than one Vanity per contact not allowed (at least at fritzbox 7390): "  +telephony[j]);  hasVanity=true;    } else out += ', ';
   }
   counter_num++;
  }
  out += "\n";
 }
 document.getElementById('phonebook_csv').value = out;
 show_errors(logError);
 return out;
 //download('csv',out);
}

function show_errors(logError){
 //show convert errors
 if(logError.length>0){
   if(selectedLanguage=='de') alert("Datei konvertiert. Es gab "+logError.length+" Fehler (möglicherweise auch unrelevant).");
   else alert("File converted. There are "+logError.length+" errors (maybe not import).");
   document.getElementById('error_logs').style.display='block';
   document.getElementById('error_logs').value='Errors in these lines:\n'+logError.join("\n");
 } else {
   document.getElementById('error_logs').style.display='none';
   document.getElementById('error_logs').value='';
 }

}

function convert_to_vcf__maybe_all(filename){ //=vcard
 var selfcall=true;
 if(document.getElementById('setting__xml2vcf__allversions').checked){
     document.getElementById('setting__xml2vcf__version').value="4.0";
     prepare_and_download( convert_to_vcf(), filename );
     document.getElementById('setting__xml2vcf__version').value="3.0";
     prepare_and_download( convert_to_vcf(), filename );
     document.getElementById('setting__xml2vcf__version').value="2.1";
     document.getElementById('set_vcf_only_for2.1').style.display='block';
     return convert_to_vcf();
 }else convert_to_vcf();
}

function convert_to_vcf(multipleDirectDownload=false){ //=vcard
 var v = document.getElementById('setting__xml2vcf__version').value; //v=Version 2.1|3.0|4.0
 var uri_encode = document.getElementById('setting__xml2vcf__uri_encode').checked;
 var add_charset = document.getElementById('setting__xml2vcf__add_charset').checked;
 var export_also_phonetype = document.getElementById('setting__xml2vcf__also_phonetype').checked;
 var export_also_email = document.getElementById('setting__xml2vcf__also_email').checked;
 var export_also_prio = document.getElementById('setting__xml2vcf__also_prio').checked;
 var text = document.getElementById('phonebook_xml').value;
 parser = new DOMParser();
 xmlDoc = parser.parseFromString(text, "text/xml");

 var out, outTotal, contacts, contact, person, telephony, telefone_numbers, telefone_numbers_type, telefone_numbers_prio, phone, tmp;
 out = ''; outTotal=''; logError=[];
 var contacts = xmlDoc.getElementsByTagName("contact");
 document.getElementById('ready_note_export_to_vcf_multivcard__counter_splited1').innerText=contacts.length;
 document.getElementById('ready_note_export_to_vcf_multivcard__counter_splited2').innerText=contacts.length;
 if(multipleDirectDownload==true){
   var text__AskMultipleVcf="It will be created and downloaded lots of files: \ncounted: "+contacts.length+" files.\nDo you want really want continue??";
   if(selectedLanguage=="de")text__AskMultipleVcf="Es werden gleiche (sehr) vielen Dateien erstellt und runtergeladen: \n"+contacts.length+" Stück. \nMöchten Sie fortfahren?";
   var text__AskMultipleVcf_name="Filename example (look in settings):\nPerson-Name: Max Muster\nFile-name: ";
   if(selectedLanguage=="de") text__AskMultipleVcf_name="Dateiname Beispiel (siehe in Einstellungen):\nPerson Name: Max Muster\nDateiname: ";
   if(!document.getElementById('setting__xml2vcf__splited__filename_fullname').checked) text__AskMultipleVcf_name+="Ma Mu_v2-1__converted_.vcf";
   var text__AskMultipleVcf_version="";
   if(document.getElementById('setting__xml2vcf__allversions').checked){
     text__AskMultipleVcf_version="Export in VCard-Version "+document.getElementById('setting__xml2vcf__version').value;
     if(selectedLanguage!="de")text__AskMultipleVcf_version+="\nIt is not possible to export in all vcard-version in this step.";
     if(selectedLanguage=="de")text__AskMultipleVcf_version+="\nEs ist nicht möglich in alle Vcard-Versionen gleichzeitig zu exportieren.";
   }
   if(!confirm(text__AskMultipleVcf) || !confirm(text__AskMultipleVcf_name)) return ""; //multipleDirectDownload=false;
   if(text__AskMultipleVcf_version!='' && !confirm(text__AskMultipleVcf_version)) return "";
 }
 for(i=0;i<contacts.length;i++)
 {
  //check values
  if(undefined==contacts[i]){ logError.push(''); continue; }
  if(
    (undefined==contacts[i].getElementsByTagName("person")[0]) ||
    (undefined==contacts[i].getElementsByTagName("person")[0].getElementsByTagName("realName")[0].firstChild.nodeValue) ||
    (undefined==contacts[i].getElementsByTagName("telephony")[0].getElementsByTagName("number")[0].firstChild.nodeValue)
  ){ logError.push(contacts[i].innerHTML); continue; }

  out = 'BEGIN:VCARD\n';
  if(v=="2.1")out += 'VERSION:2.1\n';
  if(v=="3.0") out += 'VERSION:3.0\n';
  if(v=="4.0") out += 'VERSION:4.0\n';
  contact = contacts[i];
  person  = contact.getElementsByTagName("person")[0].getElementsByTagName("realName")[0].firstChild.nodeValue;
  telephony = contact.getElementsByTagName("telephony")[0].getElementsByTagName("number");
  
  //name
  tmp = person.replace('\n','');
  if(uri_encode  && v=="2.1")tmp = encodeURI(tmp).replace(/%/g,'=');
  if(add_charset && v=="2.1")tmp = ";CHARSET=UTF-8:"+tmp;
  out += 'N:' +tmp+'\n';
  out += 'FN:'+tmp+'\n';
  
  //phone
  for(j=0;j<telephony.length;j++){
   if(null==telephony[j].firstChild || undefined==telephony[j].firstChild.nodeValue || null==telephony[j].firstChild.nodeValue) { logError.push(person); if(telephony[j].firstChild==null)logError.push('empty number:'); logError.push(telephony[j]); continue; }
   out += "TEL;";
   phone = myTrimQuotes(telephony[j].firstChild.nodeValue);
   if(document.getElementById('setting__xml2__phonenumber_edit_your_areacode__active').checked &&
     !document.getElementById('setting__xml2__phonenumber_edit_your_areacode').validity.patternMismatch ){
     var areacode__pre_phone='';
     areacode__pre_phone=document.getElementById('setting__xml2__phonenumber_edit_your_areacode').value;
     if(areacode__pre_phone.substring(0,1)=="0")areacode__pre_phone=areacode__pre_phone.substring(1);
     if(phone.substring(0,1)!="0" && areacode__pre_phone!='' && phone.match(/[2-9][0-9][0-9].*?/).length>0)phone="0"+areacode__pre_phone+phone;
   }
   if(document.getElementById('setting__xml2__phonenumber_edit_your_countrycode__active').checked &&
     !document.getElementById('setting__xml2__phonenumber_edit_your_countrycode').validity.patternMismatch ){
     var countrycode__pre_phone='';
     countrycode__pre_phone=document.getElementById('setting__xml2__phonenumber_edit_your_countrycode').value;
     if(phone.length>2 && phone.substring(0,1)!="+" && phone.substring(0,1)=="0" && phone.substring(0,2)!="00" && countrycode__pre_phone!='') phone=""+countrycode__pre_phone+""+phone.substring(1);
   }
   //if(v=="2.1" )
   if( export_also_phonetype && telephony[j].getAttribute('type')!=undefined) out +=      ''+telephony[j].getAttribute('type').toUpperCase()+';';
   //if(v!="2.1" && export_also_phonetype && telephony[j].getAttribute('type')!=undefined) out += 'TYPE='+telephony[j].getAttribute('type').toUpperCase()+';';
   out += "VOICE:"+phone+'\n';
  }
  if(export_also_prio && telephony.length>0 && telephony[0].getAttribute('prio')!='')out += "NOTE:importantContact(fritzbox)\n";
  
  //email
  if(export_also_email){
  services = Array();
  if(undefined==contact.getElementsByTagName("services")) { logError.push(services[j]); continue; }
  if(contact.getElementsByTagName("services").length>0)services = contact.getElementsByTagName("services")[0].getElementsByTagName("email");
  for(j=0;j<services.length;j++){
   if(undefined==services[j].firstChild.nodeValue) { logError.push(services[j]); continue; }
   tmp = services[j].firstChild.nodeValue;
   if(uri_encode  && v==2.1)tmp = encodeURI(tmp).replace(/%/g,'=');
   if(add_charset && v==2.1)tmp = ";CHARSET=UTF-8:"+tmp;
   out += "EMAIL:"+tmp+'\n';
  }
  }
  
  out += "END:VCARD\n";
  if(multipleDirectDownload){
    var filen=person
    if(!document.getElementById('setting__xml2vcf__splited__filename_fullname').checked) filen=filen.replace(/([^ \.;,])([^ \.;,])*/g,'$1');
    prepare_and_download(out,filen);
  }
  outTotal+=out;
 }
 document.getElementById('phonebook_vcf').value = outTotal;
 return out;
 //download('vcf',out);
}

function convert_vcf_to_xml(){
  //config
 var vcf_use_which_name = 'FN'; // F or FN 

 var text = document.getElementById('phonebook_vcf').value;
 var person, email, v;
 var out = '';
 var cantHandleCharset_showMessage=false;
 out += '<?xml version="1.0" encoding="utf-8"?>\n<phonebooks>\n<phonebook owner="" name="'+new_phonebook_name+'">\n';
 var contacts = text.split('BEGIN:VCARD');
 for(i=0;i<contacts.length;i++)
 {
  if(contacts[i]=='')continue;
  var c = contacts[i];
  var elements = contacts[i].split(/\n|\r\n/);
  var personOut='';
  var phoneOut = '';
  var EmailOut='';
  var typeOut = '';
  var v = '';
  var prio=false;
  
  for(j=0;j<elements.length;j++){ //handle utf8 hex code
    if(elements[j].search(/CHARSET=UTF-8;ENCODING=QUOTED-PRINTABLE:/)>=0){
        var match = elements[j].match("(.*);(CHARSET=UTF-8;ENCODING=QUOTED-PRINTABLE):(.*)");
        var splited = match[3].split("=");
        for(var k=0;k<splited.length;k++)
        {
          splited[k] = splited[k].replace(/;/g,""); //;;; is (mostly?) only on end of line
        }
    
        var str = '';
        for(var k=0;k<splited.length;k++){
        if(splited[k].length==0)continue;
        if(splited[k].toUpperCase()=='C2' || splited[k].toUpperCase()=='C3')
        {
            var hex=splited[k]+splited[k+1];
            try{
                str+= decodeURIComponent(hex.replace(/(..)/g,'%$1'))
            }catch(e){console.log('invalid hex input: ' + hex)}
            k++;
            continue;
        }
        str+=String.fromCharCode('0x'+splited[k]);
        }
   
        elements[j] = match[1]+':'+str;
        
     }
     else if( elements[j].search(/CHARSET=UTF-8:/)>=0){
        elements[j] = elements[j].replace(/CHARSET=UTF-8:/,'');
     }
     else if( elements[j].search(/CHARSET=/)>=0){
       if(!cantHandleCharset_showMessage)alert("sorry. Can't handle this charset. Possible some special character are wrong. Or the file is not import-able."); cantHandleCharset_showMessage=true;
     }
  }
  
  for(j=0;j<elements.length;j++){
    var str = elements[j];
    if(str.substr(0,3)=='FN:' && vcf_use_which_name=='FN'){
        strOut=str.substr(3);
        while( strOut.substr(0,1)==";" ) strOut = strOut.substr(1); //remove beginning/starting ;;;
        while( strOut.substr(-1)==";")   strOut = strOut.substr(0,str.length-1); //remove ending ;;;
        strOut = sanitize_personname(strOut,false);
        personOut = '<person><realName>'+strOut+'</realName></person>\n';
    }
    if(str.substr(0,2)=='N:' && vcf_use_which_name=='N'){
        strOut=str.substr(2);
        while( strOut.substr(0,1)==";" ) strOut = strOut.substr(1); //remove beginning/starting ;;;
        while( strOut.substr(-1)==";")   strOut = strOut.substr(0,str.length-1); //remove ending ;;;
        strOut = sanitize_personname(strOut,false);
        personOut = '<person><realName>'+strOut+'</realName></person>\n';
    }
    
    if(str.substr(0,3)=='TEL'){
        var type=''; var typeRow='';
        if(str.substr(0,9)=='TEL;TYPE='){
        //var next_sim=str.substr(0,9)
        var nextDoppelpunkt = str.substr(10).indexOf(':');
        var nextSimokolon   = str.substr(10).indexOf(';');
        var end_c = nextDoppelpunkt;
        if(nextSimokolon>0 && nextSimokolon<nextDoppelpunkt)end_c = nextSimokolon;
        if(end_c>0){
            typeRow = str.substr(9,end_c+1);
            if(typeRow.indexOf(',')>0){
                var sub = typeRow.split(',');
                for(k=0;k<sub.length;k++){
                    if(sub[k]=='WORK')     type='WORK';
                    if(sub[k]=='HOME')     type='HOME';
                    if(sub[k]=='MOBILE')   type='MOBILE';
                    if(sub[k]=='FAX_WORK') type='FAX_WORK';
                }
            } else type=typeRow;
            typeOut='type="'+type.toLowerCase()+'"';
        }else{       
          if( document.getElementById("setting__2xml__phonenumber_edit_detect_mobile__active").checked && is_this_a_mobile_phonenumber(phone))     typeOut='type="mobile"';
        }
        }
        /*else if(str.substr(0,4)=='TEL;'){
        //var next_sim=str.substr(0,9)
        var endType = str.substr(5).indexOf(':');
        var simokolon = str.substr(5).indexOf(';');
        if(endType>3 && simokolon==0)type=' TYPE="'+str.substr(9,endType-1)+'"';
        }*/
        var start = str.indexOf(':');
        phoneOut += '<number '+typeOut+' id="'+j+'">'+str.substr(start+1)+'</number>\n';
    }
    if(str.substr(0,8)=='VERSION:')v=str.substr(8);
    if(str.substr(0,5)=='NOTE:' && str.indexOf('importantContact(fritzbox)')>0)prio=true;
    if(str.substr(0,5)=='EMAIL'){
        var startEmail = str.substr(4).indexOf(':');
        //if(startEmail>=0 && str.length>9)EmailOut+='<email>'+str.substr(startEmail+1)+'</email>';
    }
  }
  
  var catNumber=0;  if(prio) catNumber = 1;
  out += '<contact>\n<category>'+catNumber+'</category>\n';
  if(prio)phoneOut=phoneOut.replace(/(<number[^>]*)(>)/,'$1 prio="1">');
  if(v==2.1)personOut = personOut.replace(/=/g,'%');
  if(v==2.1)personOut = decodeURI(personOut);
  out += personOut+'<telephony nid="'+i+'">\n' + phoneOut;
  if(EmailOut!='') EmailOut='<services>'+EmailOut+'<services>';
  out += '</telephony>\n'+EmailOut+'<setup />\n<features doorphone="0" /><mod_time></mod_time><uniqueid></uniqueid>\n</contact>\n';
 }
 out += '</phonebook>\n</phonebooks>';
 document.getElementById('phonebook_xml').value = out;
 return out;
 //download('xml',out);
}


function sanitize_personname(person,inkluding_quotes){
  person = person.replace(/^\s+|\s+$/gm,'');        //trim spaces
  //replace character & , otherwise import to fritzbox not possible
  person = person.replace(/&(?!amp;)/gm,'&amp;');
  //replace character " , otherwise import to fritzbox not possible //please dont change the order
  person = person.replace(/""/gm,"&quot;");       //handle "" (from libre office export of single " possible )
  person = person.replace(/\"/gm,"&quot;");       //handle "
  person = person.replace(/"/gm,"&quot;");        //handle "
  if(inkluding_quotes){
    var tmp = '';
    tmp= person.replace(/^"(.*)"$/gm,'$1'); //trim " (only once at beginn and end)
    if(tmp.length>0) person = tmp;
    tmp= person.replace(/^'?(.*)'?$/gm,'$1'); //trim ' (only once at beginn and end)
    if(tmp.length>0) person = tmp;
  }
  person = person.replace(/^\s+|\s+$/gm,'');        //trim spaces (again)
  return person;
}


function convert_csv_to_xml(){
  var text = document.getElementById('phonebook_csv').value;
  var out = ''; var person; logError=[];
  out += '<?xml version="1.0" encoding="utf-8"?>\n<phonebooks>\n<phonebook owner="" name="'+new_phonebook_name+'">\n';
  var contacts = CSVToArray(text);
  var hasHeadlineQuickDial=false;
  var hasHeadlineVanity   =false;
  
  
  //old:if(contacts.length>0 && contacts[0].length>1 && contacts[0][1].search(/[0-9][0-9]/)==-1)contacts[0]=""; //ignore headline (the frist line, and without any phonenumber)
  if(contacts.length>0 && contacts[0].length>1 && is_maybe_headline__object(contacts[0])){
    if(contacts[0].length>=6 && myTrimQuotes(contacts[0][5].toLowerCase())=="quickdial")hasHeadlineQuickDial=true;
    if(contacts[0].length>=7 && myTrimQuotes(contacts[0][6].toLowerCase())=="vanity")   hasHeadlineVanity   =true;
    contacts[0]="";
  }
  contacts.sort( function(a,b) { 
      if(a.length<=1)return false;   //empty lines
      if(a[0].substring(0)==b[0].substring(0)){
        if(setting__csv2xml__merge_samename==1 && a.length>3 && b.length>3 && myTrimQuotes(b[3].substring(0))=='1' && a[2].search(/[0-9][0-9]/)==-1 && b[2].search(/[0-9][0-9]/)==-1 )return true; //first numbers with "prio" (otherwise the merge function later, will not take prio for all numbers)
      }
      if(a[0].substring(0)>b[0].substring(0)) return true;
      return false;
      }
      ); //sort, in case of merge entrys later
  var lastPersonName = '';
  var lastPersonPrio = '';
  var lastPersonEmail = '';
  var lastPersonQuickdial = '';
  var lastPersonVanity = '';
  var numbersOut='';
  var numbersOutCounter=0;
  var setting__csv2xml__max_per_entry = '';//for testing 1 ; //Fritzbox 7390 does not allow more then 9 number per each entry
  var forceSplitAndJumpOverEntrys=-1;
  var countLoop_detectInfinitLoop=0;
  for(row=0;row<=contacts.length;row++)
  {
    countLoop_detectInfinitLoop++; if(countLoop_detectInfinitLoop>10000){ alert("internal programm Error: Loop"); return; }
    if(numbersOut!=''){
      if( setting__csv2xml__merge_samename==0 || forceSplitAndJumpOverEntrys>0 || row==contacts.length || contacts[row].length<=1 || lastPersonName!=contacts[row][0].substring(0) ){  //write Entrys   //on: change of Name -or- last entry in list
        out += '<contact>\n<category>0</category>\n';
        out += '<person><realName>'+person+'</realName></person>\n';
        out += '<telephony nid="'+(row-1)+'">\n';
        
        if(lastPersonPrio!='')numbersOut=numbersOut.replace(/<number/g,'<number'+lastPersonPrio);
        out += numbersOut;
        out += '</telephony>\n';
        if(lastPersonEmail!='') out += '<services nid="'+row+'"><email classifier="private" id="0">'+lastPersonEmail+'</email></services>';
        else out += '<services />';
        out += '<setup />\n<features doorphone="0" /><mod_time></mod_time><uniqueid></uniqueid>\n</contact>\n';
        numbersOut='';lastPersonEmail='';lastPersonPrio=''; numbersOutCounter=0; lastPersonQuickDial=''; lastPersonVanity='';
      }
    }
    
    if(row==contacts.length)break;
    if(contacts[row]=='')continue;
    var elements = contacts[row];
    var person = elements[0].substring(0);
    var phone  = elements[1].substring(0);
    var prio = '';
    var email = '';
    var quickDial= '';
    var vanity = '';
    var entrys = [];
    //if(row==0 && phone.search(/[0-9][0-9]/)==-1)continue; //ignore headline  //obsolute: with sort the headline is on other position. and will be dealtet before
    person = sanitize_personname(person,true);
    person = myTrimQuotes(person);
    var start = 1;
    if(forceSplitAndJumpOverEntrys>=0){ start=forceSplitAndJumpOverEntrys; forceSplitAndJumpOverEntrys=-1;}
    for(c=start;c<elements.length;c++){ //accept multiple numbers
       
       phone = elements[c];
       var type='';   //is here default type="home" needed?
       var breakAfter=false;  //incase the 3th column is type (=mobile|privat|work|...), that is a single phone-number Entry. Thats means: no more phone-numbers will follow afterwards
       if(phone.length==0)continue;
       if(phone.search(/[0-9]/)==-1) logError.push(elements.join(',')); //maybe not a phone number?; Anyway: continue
       phone = myTrimQuotes(phone);
       
       if( document.getElementById("setting__2xml__phonenumber_edit_detect_mobile__active").checked && is_this_a_mobile_phonenumber(phone))     type="mobile";
       
       if( document.getElementById('setting__csv2xml__max_per_entry_checkbox').checked && setting__csv2xml__max_per_entry!='' && numbersOutCounter==setting__csv2xml__max_per_entry) { forceSplitAndJumpOverEntrys=c; row=row-1;  break; } //create a new Entry (workaround)
       //input style: name, phone, prio, email   //=no multiple numbers
       if(elements[2]!=undefined && phonetypes.indexOf(myTrimQuotes(elements[2]))>=0 && elements[2]!='') {
       //incase the 3th column is type (=mobile|privat|work|...), that is a single phone-number Entry. Thats means: no more phone-numbers will follow afterwards
          type=myTrimQuotes(elements[2]);
          breakAfter=true;
          if(elements[3]!=undefined && (myTrimQuotes(elements[3])=='1' || elements[3]==1))  prio=1;
          if(elements[4]!=undefined && elements[4].search(/@/)!=-1 && elements[4].length>=5) email=myTrimQuotes(elements[4]);
          if(hasHeadlineQuickDial && elements[5]!=undefined && myTrimQuotes(elements[5]).match(/^[0-9]*$/)>0 && elements[5].length>=1){
            if(quickDial!='')   logError.push("Warning:more than one QuickDial per contact not allowed (at least at fritzbox 7390): "  +elements[1]);  
            quickDial=myTrimQuotes(elements[5]);
          }
          if(hasHeadlineVanity && elements[6]!=undefined && myTrimQuotes(elements[6]).match(/^[0-9]*$/)>0 && elements[6].length>=1){
            if(vanity!='')      logError.push("Warning:more than one Vanity per contact not allowed (at least at fritzbox 7390): "     +elements[1]);
            vanity=myTrimQuotes(elements[6]);
          }
       }
      
      if(prio!='') prio=' prio="1"';
      var add='';
      if(type!='')      add+=' type="'+type+'"';
      if(quickDial!='') add+=' quickdial="'+quickDial+'"';
      if(vanity!='')    add+=' vanity="'+vanity+'"';
      numbersOut += '<number'+add+'>'+phone+'</number>\n'; 
      numbersOutCounter++;
          //old:     //'+prio+' //moved to late (in case of merged entrys)
      
       if(breakAfter) break;
      }
      
      if(quickDial!='')lastPersonQuickDial=quickDial;
      if(vanity!='')lastPersonVanity=vanity;
      if(lastPersonName!=person)lastPersonEmail=email;
      else if(lastPersonEmail=='' && email!='')lastPersonEmail=email;
      if(lastPersonName!=person)lastPersonPrio=prio;
      else if(lastPersonPrio==''  && prio!='' )lastPersonPrio=prio;
      if(lastPersonName!=person) lastPersonName=person;
      
      

  }

  out += '</phonebook>\n</phonebooks>';
  document.getElementById('phonebook_xml').value = out;
  show_errors(logError);
  return out;
  //download('xml',out);
}

function get_filename(filename_with_path) {
    var lin = filename_with_path.split('\\');
    var win = filename_with_path.split('/');
    if(lin.length>win.length) filename = lin[lin.length-1];
    else filename = win[lin.length-1];
    return filename;
}

function download_one_file_ask(){
  if (confirm('Download text in .xml window?')) { uploaded_file_convert_to='xml'; prepare_and_download(document.getElementById('phonebook_xml').value); return; }
  if (confirm('Download text in .csv window?')) { uploaded_file_convert_to='csv'; prepare_and_download(document.getElementById('phonebook_csv').value); return; }
  if (confirm('Download text in .vcf window?')) { uploaded_file_convert_to='vcf'; prepare_and_download(document.getElementById('phonebook_vcf').value); return; }
}
function prepare_and_download(text,filename) {
  if(text==undefined || text==null || text==false || text==""){ alert("Finish. End. No Output. Nothing to output."); return;}
  if(filename == undefined || filename=='') filename='';
  if(filename=='') filename='phonebook_for_fritzbox';
  if(uploaded_file_convert_to=='xml'){
   filename = filename.replace(/(\.)(csv)$/i,'_$2');
   filename = filename.replace(/(\.)(vcf)$/i,'_$2');
   filename += "_converted_.xml";
  }
  if(uploaded_file_convert_to=='csv' || uploaded_file_convert_to=='vcf'){
   if(filename!='')filename = filename.replace(/(\.)(xml)$/i,'_$2');
   if(document.getElementById('setting__xml2vcf__allversions').checked) filename += '_v'+document.getElementById('setting__xml2vcf__version').value.replace(/\./,'-')+'_';
   filename += "_converted_."+uploaded_file_convert_to;
  }
  counter_convert++;
  downloadAction(filename, text);
}
function download_sourcecode(){
  var filename = '';
  var text = document.getElementsByTagName('html')[0].outerHTML;
  uploaded_file_convert_to='html'
  var filename_add = '';
  if (typeof document.querySelector !== "undefined") { 
      var jsonld = JSON.parse(document.querySelector('script[type="application/ld+json"]').innerText);
      if (typeof jsonld !== "undefined" && jsonld.softwareVersion !== "undefined" && jsonld.dateModified !== "undefined" ) filename_add = " v"+jsonld.softwareVersion.replace(/\./,'-')+" "+jsonld.dateModified.replace(/\./,'-');
  }
  filename = 'converter phonebook fritzboxxml csv vcf vcard '+filename_add+'.'+uploaded_file_convert_to;
  text="<!DOCTYPE html>"+text;
  downloadAction(filename,text);
}
function downloadAction(filename, text) {
  if(text==undefined || text=="undefined" || text==false || text==""){alert("Error");return;}
  var element = document.createElement('a');
  if     (uploaded_file_convert_to=='vcf') element.setAttribute('href', 'data:text/vcard;charset=utf-8,'      + encodeURIComponent(text));
  else if(uploaded_file_convert_to=='csv') element.setAttribute('href', 'data:text/csv;charset=utf-8,'        + encodeURIComponent(text));
  else if(uploaded_file_convert_to=='xml') element.setAttribute('href', 'data:application/xml;charset=utf-8,' + encodeURIComponent(text));
  else if(uploaded_file_convert_to=='html')element.setAttribute('href', 'data:text/html;charset=utf-8,'       + encodeURIComponent(text));
  else                                     element.setAttribute('href', 'data:text/plain;charset=utf-8,'      + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
  
  document.getElementById('ready').style.display="block";
  if(counter_convert%2){ document.getElementById('ready').style.border="solid 1pt black"; document.getElementById('ready').style.background='#fff'; }
  else { document.getElementById('ready').style.border=""; document.getElementById('ready').style.background='#aaa';}
  //window.setTimeout("document.getElementById('ready').style.display='none';",10000);
  document.getElementById('ready_note_export_to_vcf_multivcard').style.display='none';
  document.getElementById('ready_note_export_to_vcf_allversions').style.display='none';
    if(uploaded_file_convert_to=='vcf'){
      document.getElementById('ready_note_export_to_vcf_multivcard').style.display='block';
      if(document.getElementById('setting__xml2vcf__allversions').checked)
        document.getElementById('ready_note_export_to_vcf_allversions').style.display='block';
  }
}

function myTrimQuotes(aa){
  aa = aa.replace(/^\s+|\s+$/g,''); //trim spaces
  aa = aa.replace(/^"+|"+$/g,'');   //trim "
  aa = aa.replace(/^'+|'+$/g,"");   //trim '
  aa = aa.replace(/^\s+|\s+$/g,''); //trim spaces
  return aa;
}

function is_this_a_mobile_phonenumber(phone){
  var your_default_country_code = document.getElementById("setting__2xml__phonenumber_edit_detect_mobile__your_countrycode").value;
  if(phone.length<=5)return false;
  for(i=0;i<pre_numbers__with_country_codes__and_mobile.length;i++){
    var a= pre_numbers__with_country_codes__and_mobile[i];
    var pattern = "(";
    if(your_default_country_code==a[2]) pattern+="0|";
    pattern+=a[2].replace(/\+/,"\\\\+")+"|"+a[2].replace(/\+/,"00")+")";
    pattern ="^"+pattern+"("+a[3]+")";
    if( phone.search(new RegExp(pattern))>=0)return true;
  }
  return false;
}

// reference: https://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm
// (( reference: http://stackoverflow.com/a/1293163/2343 ))
// "All code here is provided as is and can be used at your own discretion." OR use "MIT" Licence :  reference : https://www.bennadel.com/blog/license.htm
// This will parse a delimited string into an array of
// arrays. The default delimiter is the comma, but this
// can be overriden in the second argument.
function CSVToArray( strData, strDelimiter ){
    // Check to see if the delimiter is defined. If not,
    // then default to comma.
    strDelimiter = (strDelimiter || ",");

    // Create a regular expression to parse the CSV values.
    var objPattern = new RegExp(
        (
            // Delimiters.
            "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

            // Quoted fields.
            "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

            // Standard fields.
            "([^\\" + strDelimiter + "\\r\\n]*))"
        ),
        "gi"
        );


    // Create an array to hold our data. Give the array
    // a default empty first row.
    var arrData = [[]];

    // Create an array to hold our individual pattern
    // matching groups.
    var arrMatches = null;


    // Keep looping over the regular expression matches
    // until we can no longer find a match.
    while (arrMatches = objPattern.exec( strData )){

        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];

        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
            strMatchedDelimiter.length &&
            strMatchedDelimiter !== strDelimiter
            ){

            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push( [] );

        }

        var strMatchedValue;

        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).
        if (arrMatches[ 2 ]){

            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            strMatchedValue = arrMatches[ 2 ].replace(
                new RegExp( "\"\"", "g" ),
                "\""
                );

        } else {

            // We found a non-quoted value.
            strMatchedValue = arrMatches[ 3 ];

        }


        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
    }

    // Return the parsed data.
    return( arrData );
}

function check_filetype_ext(filename, ext_target){
  var filetype_by_ext = get_filetype_by_ext(filename);
  if( typeof filetype_by_ext.toLowerCase() === "undefined" ) return true;
  if( filetype_by_ext.toLowerCase()==ext_target ) return true;
  return confirm("This filename does not end with ."+ext_target+". Continue anyway?");
}

function get_filetype_by_ext(filename){
  var t = filename.split('.');
  var filetype_by_ext = '';
  if (t.length>0) filetype_by_ext = t[t.length-1];
  return filetype_by_ext;
}

function ask__xml_convert_to(filename) {
  if( confirm("convert to .csv?") ) { uploaded_file_convert_to='csv'; return convert_to_csv(); }
  else if( confirm("convert to .vcf? (vcard)") ) { uploaded_file_convert_to='vcf'; return convert_to_vcf__maybe_all(filename); }
}

function f_merge__appendfile(format,origin,add){
  if(!do_a_merge)return add;
  if(format=="xml"){
     var start =add.search(/<contact/);
     if(start<=0){ alert("no entry found in one file");return origin;} //=not found
     if(origin.length==0) origin=add;
     else {
       var end=add.search(/[(\r\n)|(\n\r)|\r|\n]<\/phonebook>/);
       if(end<=0){ alert("no entry found in one file");return origin;} //=not found
       origin=origin.replace(/(<\/phonebook>)/,add.substring(start,end)+"</phonebook>");
     }
  }
  if(format=="csv"){
     if(origin.length==0) origin=add;
     else {       
       if(is_maybe_headline__fulltext(add))add=add.replace(/^([^(\r\n)|(\n\r)|\n|\r])*/,''); //delete 1st Line = normaly = Headline
       origin+=add;
     }
  }
  if(format=="vcf")   origin+=add;
  return origin;
}

function is_maybe_headline__object(a){ //for .csv  //just a single line
  if( typeof a=='object'){
      if(myTrimQuotes( a[0] ).toLowerCase() =="name" )    return true;
      if(myTrimQuotes( a[1] ).toLowerCase() =="phone" )   return true;
      if(myTrimQuotes( a[1] ).search(/[0-9][0-9][0-9]/) ==-1 ) return true; //ignore headline (the frist line, and without any phonenumber)
  }
  return false;
}
function is_maybe_headline__fulltext(a){ //for .csv  //alle lines in one string
  if( typeof a=='string'){
      var first_linebreak = a.search(/((\r\n)|(\n\r)|\n|\r])/);
      var first_line = a.substring(0,first_linebreak);
      if(first_line.length<5)return true;
      var b = CSVToArray(first_line);
      if(b[0].length<2)return false;
      return is_maybe_headline__object(b[0]);
  }
  return false;
}

var do_a_merge = false;
var readfiles__files_count = 0;
var readfiles__files_counter = 0;
var f_merge_c = Array();
f_merge_c["xml"] = 0;
f_merge_c["csv"] = 0;
f_merge_c["vcf"] = 0;
  
function readMultipleFiles(e) {
  f_merge_c["xml"] = 0;
  f_merge_c["csv"] = 0;
  f_merge_c["vcf"] = 0;
  do_a_merge=false;
  readfiles__files_counter = 0;
  document.getElementById('file-input_reset').style.display='block';
  var files = e.target.files;
  if (!files || files.length==0) {
    return;
  }
  document.getElementById('convert_again_file').style.display='block';
  var text__AskShouldIMerge="Merge the multiple files to a single phonebook? \n(only with the same file-format possible)";
  if(selectedLanguage=="de")text__AskShouldIMerge="Zusammenfügen von verschiedenen einzelenen Telefonbüchern zu einen einzigen?";
  if(files.length>1 && confirm(text__AskShouldIMerge)) do_a_merge=true;
  
  readfiles__files_count = files.length;
  for(i=0;i<files.length;i++){
      var file = files[i];
      var reader = new FileReader();
      if(e.target.id=='file-input_auto-detect'){
        reader.fileName = file.name;
        reader.fileType = file['type'];
        reader.onload = function(e) {
          var type_from = '';
          var contents = e.target.result;
          var filename = get_filename(e.target.fileName);
          var filetype_by_ext = get_filetype_by_ext(filename).toLowerCase();
          if( typeof filetype_by_ext === "undefined" ) filetype_by_ext ='';
          if (document.getElementById('setting__upload__filetype_auto_detect').checked && ( filetype_by_ext!='' || e.target.fileType!='' )  ){
              if( filetype_by_ext=='xml' || e.target.fileType=='application/xml' || e.target.fileType=='text/xml' ) type_from="xml";
              if( filetype_by_ext=='csv' || e.target.fileType=='text/csv' ) type_from="csv";
              if( filetype_by_ext=='vcf' || e.target.fileType=='text/vcard' || e.target.fileType=='text/x-vcard' || e.target.fileType=='text/directory;profile=vCard' || e.target.fileType=='text/directory' ) type_from="vcf";
          }
          if(type_from==''){
            if(      confirm("Is this a .xml file?") ) type_from="xml";
            else if( confirm("Is this a .csv file?") ) type_from="csv";
            else if( confirm("Is this a .vcf file?") ) type_from="vcf";
          }
          readfiles__files_counter++;
          if(type_from==''){ alert("ignore this file"); return; }

          var textfield_id = "phonebook_"+type_from;

          if(!do_a_merge){ //single file(s)
              document.getElementById(textfield_id).value = contents;
              if(type_from=="xml"){ uploaded_file_convert_from='xml'; prepare_and_download( ask__xml_convert_to(filename) , filename);}
              if(type_from=="csv"){ uploaded_file_convert_from='csv'; uploaded_file_convert_to='xml'; prepare_and_download( convert_csv_to_xml() , filename); }
              if(type_from=="vcf"){ uploaded_file_convert_from='vcf'; uploaded_file_convert_to='xml'; prepare_and_download( convert_vcf_to_xml() , filename); }
          }
          if(do_a_merge){ //merged files
            if(f_merge_c[type_from]==0)  document.getElementById(textfield_id).value= '';
            f_merge_c[type_from]++;
            document.getElementById(textfield_id).value = f_merge__appendfile(type_from,document.getElementById(textfield_id).value,contents);
            if(readfiles__files_count==readfiles__files_counter){ //last file
              filename+="_merged_";
              reader_finish__andDownloadMergedFile(filename);
            }
          }
        };
      }
      reader.readAsText(file);
  }
}

function reader_finish__andDownloadMergedFile(filename){
   if(do_a_merge) if(
     (f_merge_c["xml"]>0 && (f_merge_c["csv"]>0 || f_merge_c["vcf"]>0) ) ||
     (f_merge_c["csv"]>0 && (f_merge_c["vcf"]>0 || f_merge_c["xml"]>0) ) ||
     (f_merge_c["vcf"]>0 && (f_merge_c["xml"]>0 || f_merge_c["csv"]>0) )
     ) { alert("Error: Please only upload files of a one single type (e.g. only .xml files). No mixing allowed."); return; }
   if(f_merge_c["xml"]>0){ uploaded_file_convert_from='xml'; prepare_and_download( ask__xml_convert_to(filename) , filename);}
   if(f_merge_c["csv"]>0){ uploaded_file_convert_from='csv'; uploaded_file_convert_to='xml'; prepare_and_download( convert_csv_to_xml() , filename); }
   if(f_merge_c["vcf"]>0){ uploaded_file_convert_from='vcf'; uploaded_file_convert_to='xml'; prepare_and_download( convert_vcf_to_xml() , filename); }
}


document.getElementById('file-input_auto-detect')
  .addEventListener('change', readMultipleFiles, false);


//document.getElementById('file-input_auto-detect').value='';
//reset_to_default();

function show_advanced_view(state){
 var e = document.getElementsByClassName('advanced_view');
 for(i=0;i<e.length;i++){
  if(state=='show')e[i].style.display='inline-block';
  if(state=='hide')e[i].style.display='';
 }
 if(state=='show'){
   show_advanced_view__state = true;
   document.getElementById("show_advanced_view_link_wrapper").style.display='none';
   document.getElementById("show_advanced_view_link_link_close").style.display='block';
   document.getElementById("file-input_reset").style.display='none';
 }
 if(state=='hide'){
   show_advanced_view__state = false;
   document.getElementById("show_advanced_view_link_wrapper").style.display='';
   document.getElementById("show_advanced_view_link_link_close").style.display='none';
   if(document.getElementById('file-input_auto-detect').value!='')document.getElementById('file-input_reset').style.display='block';
 }
}

//drag and drop:
let dropArea = document.getElementById('file-input_auto-detect');
let dropArea_CloseButton = document.getElementById('file-input_auto-detect_close_button');
let dropAreaText = document.getElementById('file-input_auto-detect_text_drophere');
let dropAreaDetect = document.getElementsByTagName('body')[0];

function preventDefaults (e) {
  e.preventDefault()
  e.stopPropagation()
}

function highlight(e) {
  dropArea.classList.add('drop-area_highlight');
  dropAreaText.classList.add('drop-area_text_highlight');
  dropAreaText.style.display='block';
  dropAreaText.style.marginTop='15%';
  dropAreaText.style.background='none';
  dropArea_CloseButton.style.display='block';
}

function unhighlight(e) {
  dropArea.classList.remove('drop-area_highlight');
  dropAreaText.classList.remove('drop-area_text_highlight');
  dropAreaText.style.display='none';
  dropArea_CloseButton.style.display='none';
}

dropAreaDetect.addEventListener('dragenter', highlight, false);
dropAreaDetect.addEventListener('dragover', highlight, false);

dropAreaDetect.addEventListener('dragleave', unhighlight, false);
dropAreaDetect.addEventListener('drop', unhighlight, false);

//-->
</script>
<br><br><br>
<hr>
<footer>
<!--<em style="color:#ababab;float:right;padding-right:10pt; ">file process only name & phone number</em>-->
<details lang="en" class="en" id="sec_adv_en"><summary onclick="window.scrollBy(0, 100);window.setTimeout('window.scrollBy(0, 100);',50)" title="more privacy info">Full Data-Privacy</summary><div>You Privacy are keept: This Page works just on your computer (or offline). Your Data will stay only on your own local computer. No Cloud. It is just pure local JavaScript-Code in your Browser. <br><br>You are still unsure, using this?: My Security-Advise:<br><a name="sec_adv_en" />
<p>Option A:
  <ol>
    <li>Start Privacy- / Incognito-Mode in your Browser <i syle="color:#999">( e.g. Firefox, Chrome,..)</i> and open again this page. <br>(More easy: <a href="sec_adv_en">click here</a> with right mouse-click and select <em>"open Link in new private window"</em> <span class="onlytouchscreen">/ <em>"open in new private Tab"</em> and <em>Tab change</em> (at buttom)</span> )</li>
    <li><span class="onlineoffline_state"></span> go offline (= disconnect from Internet )</li>
    <li>Convert your files</li>
    <li>Important last Step: Close <u>ALL</u> Privacy/Incognito-Mode window afterwards, to finish up / clean up the whole <em>session</em>.</li>
  </ol>
</p>
<p>
Option B (alternativ) :
 <ol>
   <li>Download this Page: 
     <ul>
      <li><a href="#" onclick="download_sourcecode()">click here</a> or </li>
      <li>alternative <a href="https://codeberg.org/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/raw/branch/pages/fritzbox_phonebook_convert.html">here</a> or </li>
      <li><i>save page</i> in your Browser <i>(e.g.: Menue File -&gt; Save Page - or - press hotkey <kbd>STRG</kbd>+<kbd>s</kbd>)</i></li>
     </ul>
   </li>
   <li><span class="onlineoffline_state"></span> go offline (= disconnect from Internet ) </li>
   <li>open to your Download folder</li>
   <li>open the downloaded .html file at your computer. It should be automatically open in your browser (<i>e.g. Firefox, Chrome,..</i>).</li>
  </ol>
</p>
</div></details>
<details lang="de" class="de" id="sec_adv_de"><summary onclick="window.scrollBy(0, 100);window.setTimeout('window.scrollBy(0, 100);',50);startOnlineOfflineStateReport();" title="more privacy info">voller Datenschutz</summary><div>

Diese Seite arbeitet als offline-Programm (reines JavaScript im Browser). Anonymität, Datenschutz ist daher gewahrt. Ihre Daten bleiben nur auf ihren Computer. Keine Cloud. Es ist reines, lokal ausgeführtes JavaScript. <br>Immernoch unsicher das hier zu nutzen?: Mein Sicherheits-Ratschlag:<br><a name="sec_adv_de" />
<p>
Option A:
  <ol>
    <li>Den Privat- / Inkognito-Modus in Ihren Internet-Browser <i style="color:#999">( z.B. Firefox, Chrome,..)</i> starten und diese Seite erneut öffnen.<br>  Schneller Weg: <a href="#sec_adv_de">hier klicken</a> mit rechter Maustasten und dann auswählen <span class="onlytouchscreen">(oder lange drücken bei Touchscreens)</span>: <em>"Link in neuem privaten Fenster öffnen"</em> <span class="onlytouchscreen">/ <em>"in neuem privaten Tab öffnen"</em> und <em>in Tab wechsel</em> (unten)</span> )</li>
    <li><span class="onlineoffline_state"></span> gehen Sie offline (= trennen Sie die Verbindung zum Internet)</li>
    <li>wandeln Sie nun Ihre Datei um</li>
    <li>Wichtiger letzter Schritt: Schließen Sie <u>ALLE</u> ihre Privat/Inkognito-Modus Fenster dannach. Nur so kann die ganze sog. <i>Sitzung</i> gelöscht, also wirklich beendet werden.</li>
  </ol>
</p>
<p>
Option B (alternativ) :
  <ol>
   <li>Download dieser Internet-Seite: 
     <ul>
      <li> <a href="#" onclick="download_sourcecode()">Hier klicken</a> oder </li>
      <li>alternativ <a href="https://codeberg.org/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/raw/branch/pages/fritzbox_phonebook_convert.html">hier</a> oder </li>
      <li><i>Seite speichern</i> in ihren Internet-Browser wählen <i>(z.B.: Menü Datei -&gt; Seite speichern - oder - Tastenkombination <kbd>STRG</kbd>+<kbd>s</kbd>)</i></li>
     </ul>
   </li>
   <li><span class="onlineoffline_state"></span> gehen Sie offline (= trennen Sie die Verbindung zum Internet) </li>
   <li>öffnen Sie den Download Ordner</li>
   <li>öffnen Sie die runtergeladenen .html Datei auf ihren Computer. Es sollte sich automatisch in ihren Internet-browser (<i>z.B. Firefox, Chrome,..</i>) öffnen.</li>
  </ol>
</p>
</div></details><br/>
<details lang="en" class="en"><summary onclick="window.scrollBy(0, 100);window.setTimeout('window.scrollBy(0, 100);',50)" title="open .csv file in libreoffice / openoffice">Help: open .csv in LibreOffice</summary><div>How to open the .csv file in LibreOffice / OpenOffice:<ul><li>Please select <i>comma</i> as seperator. </li><li>Under <i>other options</i>: Please select <i>Format quoted fields as text</i> (otherwise the phone-Number may miss the beginning 0 <-- at least in  LibreOffice (version 7.4.7.2)-->)</li></ul><br><img src="img/libre_office_open_import_csv__en_8bit.png" alt="screenshot: import .csv-files settings in LibreOffice" /></div></details>
<details lang="de" class="de"><summary onclick="window.scrollBy(0, 100);window.setTimeout('window.scrollBy(0, 100);',50)" title="öffnen der .csv Datei in libreoffice / openoffice">Hilfe: öffne .csv in Libreoffice</summary><div>So öffnet man die .csv Datei in LibreOffice / OpenOffice:<ul><li>Bitte als Trenner <i>Komma</i> auswählen. </li><li>Unter <i>weitere Optionen</i>: Bitte anklicken von <i>Felder in Hochkommata als Text formatieren</i> (ansonsten könnte bei der Telefon-nummer die 0 am Anfang fehlen <!-- zumindest in LibreOffice (version 7.4.7.2)-->)</li></ul><br><img src="img/libre_office_open_import_csv__de_8bit.png" alt="Bildschirmfoto: import .csv-Datei Eintellungen in LibreOffice" /></div></details>
<details style="padding-right:4pt;">
 <summary>
  <span lang="en" class="en">About this Service</span>
  <span lang="de" class="de">Über diesen Dienst / Seite</small></span>
 </summary>
 <span lang="en" class="en">
 <h3>Description:</h3>

This is a Web-App, or call it online convert-Service .
<br />
Possible to convert:
<ul>
<li> Fritzbox <em>.xml</em> to <em>.csv</em></li>
<li> <em>.csv</em> to Fritzbox <em>.xml</em></li>

<li> Fritzbox <em>.xml</em> to <em>.vcf</em> / Vcard</li>
<li> <em>.vcf</em> / Vcard to Fritzbox <em>.xml</em></li>
</ul>
Other functions:
<ul>
<li> Multiple Files can be selected and merge before: .csv or .vcf Files. (press <kbd>STRG</kbd> while file selection).</li>
<li> open the .csv file in your Office Programm (e.g. LibreOffice).</li>
<li> It's running in directly your browser. ( No need of installation. No server. No Cloud. Only local Programm-Code. )</li>
</ul>
 
</span>
<span lang="de" class="de">
 <h3>Beschreibung:</h3>
Dies ist eine Web-App, oder nenne es online konvertier Dienst.
<br />
Möglich umzuwandeln ist:
<ul>
<li> Fritzbox <em>.xml</em> zu <em>.csv</em></li>
<li> <em>.csv</em> zu Fritzbox <em>.xml</em></li>

<li> Fritzbox <em>.xml</em> zu <em>.vcf</em> / Vcard</li>
<li> <em>.vcf</em> / Vcard zu Fritzbox <em>.xml</em></li>
</ul>

Weitere Funktionen:
<ul>
<li> Mehrere Dateien auswählen und vorher zusammenfügen: .csv und .vcf Dateien können vorher zusammengefügt werden. (beim Hochladen <kbd>STRG</kbd> gedrückt halten)</li>
<li> öffne die .csv Dateien in Ihren Office Programm (z.B. LibreOffice).</li>
<li> Es läuft direkt im Browser.  ( Es ist keine Installtion nötig. Kein Server. Keine Cloud. Nur lokal ausgeführte Programmcode. )</li>
</ul>
</span>
<aside>
 <h3>Alternative Services / Tools</h3>
 <ul>
  <li>Online Web-Service: (local JavaScript inside Browser)<br/>
convert .xml to .vcf (=export) <br/>
<a href="https://blog.rillke.com/fritzXML2vcard/">https://blog.rillke.com/fritzXML2vcard/</a>  &nbsp; ; &nbsp; <a href="https://github.com/Rillke/fritzXML2vcard?tab=readme-ov-file">Sourcecode</a> <br>
<span lang="en" class="en">This Tool can export to multiple .vcf files. You can (de)-select each single contact. Or you can export single contacts (also copy & paste possible).</span>
<span lang="de" class="de">Dieses Tool kann mehrere .vcf Dateien erstellen. Man kann einzelne Kontakte auswählen oder auch raus-löschen. Es ist auch der export einzelner Kontakte möglich (auch Copy & Paste möglich)</span>
</li>
  <li>Computer-Programm:<br/>
   <span lang="en" class="en">supports lots of file-formats</span><span lang="de" class="de">Unterstützt sehr viele Datei-Formate</span> (=import/export) <br/>
   <a href="https://github.com/Rillke/Contact-Conversion-Wizard">https://github.com/Rillke/Contact-Conversion-Wizard</a> (based on <a href="https://web.archive.org/web/20160408131050/http://software.nv-systems.net/ccw/download/">https://web.archive.org/web/20160408131050/http://software.nv-systems.net/ccw/download/</a> )</li>
  <li>Computer-Programm (Java ; No GUI, just a Comand Line Tool) <span lang="en" class="en">Keine Grapische Oberfläche (=GUI), sonder nur als Komando-Zeilen-Progamm (="Eingabeaufforderung") verwendbar</span> (=import/export):<br/>
   .vcf (vcard) or .csv to Fritzbox .xml (=import) <br/>
   <a href="https://github.com/berkholz/vcard2fritzXML">https://github.com/berkholz/vcard2fritzXML</a> </li>
  <li>Computer-Programm (C++ ; for Windows und Linux):<br/>
  csv , vcf , xml , vcard QR-Code für Android &nbsp; (=import/export) <br/>
  <a href="http://www.sigvdr.de/Software/EasyKontakt/EasyKontakt.html">http://www.sigvdr.de/Software/EasyKontakt/EasyKontakt.html</a>
  <li> ... lots of other... </li>
</ul>
</aside>
 <h3>Sourcecode</h3>
 <small lang="en" class="en">Or also report error / issue there.</small><small lang="de" class="de">Oder auch Fehler melden dort.</small><br>
Licence: <a href="LICENSE" rel="jslicense">APGL</a> and  | Version: <span id="version_out"></span> | <a href="#" onClick="download_sourcecode();return false">Download this page (without images)</a><br>
Developer-Portal "codeberg": <a href="https://codeberg.org/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/">https://codeberg.org/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/</a> &nbsp; ; &nbsp; <a href="https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/commits/master">change-Log/History</a>
<br>or <br>
Developer-Portal "github": <a href="https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/">https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/</a> &nbsp; ; &nbsp; <a href="https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv_vcf/commits/master">Change-Log/History</a>
</details>

</footer>
<br/>

<script language="JavaScript">

//translation text replace
var selectedLanguage=null;
var language = window.navigator.userLanguage || window.navigator.language;
var all_languages=Array('en','de');
if(window.location.hash.length>2 && all_languages.indexOf( window.location.hash.substring(1) )>=0) changeLanguage( window.location.hash.substring(1) );
else if(language.substring(0,2)=='de')changeLanguage('de');
window.addEventListener('hashchange', function(){ 
    if(window.location.hash.length>2 && all_languages.indexOf( window.location.hash.substring(1) )>=0) changeLanguage( window.location.hash.substring(1) ); 
    });
function changeLanguage(newSetLang){
 selectedLanguage=newSetLang;
 var e = document.getElementsByClassName(newSetLang);
  for(i=0;i<e.length;i++){
   e[i].style.display='inline-block';
   if(e[i].tagName=="H1") e[i].style.display='block';
  }
 for(j=0;j<all_languages.length;j++){
  if(all_languages[j]==newSetLang)continue;
  var e = document.getElementsByClassName(all_languages[j]);
  for(i=0;i<e.length;i++){
   e[i].style.display='none';
  }
  }
  if(window.location.hash.length>2 && all_languages.indexOf( window.location.hash.substring(1) )>=0){
  document.documentElement.lang=newSetLang;
  document.getElementsByTagName('html')[0].setAttribute('lang',newSetLang);}
  else if(document.documentElement.lang!='') document.documentElement.lang='';
}

//Help Privacy & Help Privacy show Offline state in 
if(window.location.hash=="#sec_adv_en")document.getElementById("sec_adv_en").open="open";
if(window.location.hash=="#sec_adv_de")document.getElementById("sec_adv_de").open="open";
startOnlineOfflineStateReport_done=false;
function startOnlineOfflineStateReport(){
    if(window.navigator.onLine!=undefined && !startOnlineOfflineStateReport_done){
      window.addEventListener('online',  offline_note );
      window.addEventListener('offline', offline_note );
      startOnlineOfflineStateReport_done=true;
    }
}
function offline_note(){
    var text=''; var c_color='';
    if(window.navigator.onLine=='off' || window.navigator.onLine==false ){ text='&check;'; c_color='green';}
    var elems=document.getElementsByClassName('onlineoffline_state');
    for(i=0;i<elems.length;i++){
      elems[i].innerHTML=text;
      elems[i].style.color=c_color;
    }
}
if(window.navigator.onLine!=undefined && window.navigator.onLine=='offline') offline_note();

if(new FileReader==undefined)alert("Sorry, your Internet-Browser is too old. You can not use this Service :-( "); //just for old Browsers before Year ~ 2010/2013
if (typeof document.querySelector !== "undefined") { //version-info in help
  var jsonld = JSON.parse(document.querySelector('script[type="application/ld+json"]').innerText);
  if (typeof jsonld !== "undefined" && jsonld.softwareVersion !== "undefined" && jsonld.dateModified !== "undefined" ) document.getElementById('version_out').innerText = " v"+jsonld.softwareVersion+" "+jsonld.dateModified;
}
</script>
</body></html>
